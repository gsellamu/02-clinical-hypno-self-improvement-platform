# PHASE 2 INTEGRATION GUIDE
# E&P Assessment + ResilientMind Platform

## OVERVIEW

This guide shows how to integrate the **Suggestibility Adapter Agent** (Phase 2) with your existing **HypnoResilientMind** platform.

**Goal:** Every hypnotherapy script generated by your AutoGen agents will be automatically personalized based on the user's E&P Assessment results.

---

## ARCHITECTURE: BEFORE vs AFTER

### BEFORE (ResilientMind Current State):
```
User: "I am stressed"
  ‚Üì
FastAPI Core ‚Üí AutoGen Agent ‚Üí MCP RAG ‚Üí PostgreSQL
  ‚Üì
Generic Response (not personalized)
```

### AFTER (With Phase 2):
```
User: "I am stressed"
  ‚Üì
FastAPI Core ‚Üí
  1. E&P Preferences Client ‚Üí E&P Assessment API ‚≠ê NEW
  ‚Üì
  2. AutoGen Team:
     - Adapter Agent (fetches E&P preferences) ‚≠ê NEW
     - RAG Agent (retrieves HMI scripts)
     - Script Generator (creates personalized script)
  ‚Üì
  3. Language Pattern Adapter (transforms to Physical/Emotional) ‚≠ê NEW
  ‚Üì
Personalized Response (adapted to suggestibility type)
```

---

## STEP 1: INSTALL PHASE 2 COMPONENTS

### 1.1 Copy Files to ResilientMind Project

```powershell
# Your ResilientMind project structure
D:\ChatGPT Projects\genai-portfolio\projects\
‚îú‚îÄ‚îÄ 01-clinical-hypno-resilientmind-mcp-ragagents\
‚îÇ   ‚îî‚îÄ‚îÄ services\
‚îÇ       ‚îî‚îÄ‚îÄ core\
‚îÇ           ‚îî‚îÄ‚îÄ src\
‚îÇ               ‚îî‚îÄ‚îÄ app\
‚îÇ                   ‚îú‚îÄ‚îÄ hypno_autogen_final.py  # We'll modify this
‚îÇ                   ‚îú‚îÄ‚îÄ ep_preferences_client.py  ‚≠ê NEW - Copy here
‚îÇ                   ‚îú‚îÄ‚îÄ language_pattern_adapter.py  ‚≠ê NEW - Copy here
‚îÇ                   ‚îî‚îÄ‚îÄ suggestibility_adapter_agent.py  ‚≠ê NEW - Copy here
```

### 1.2 Install Dependencies

```powershell
# Activate your ResilientMind venv
cd "D:\ChatGPT Projects\genai-portfolio\projects\01-clinical-hypno-resilientmind-mcp-ragagents"
.\.venv\Scripts\activate

# Install new dependencies
pip install httpx redis
```

### 1.3 Update Requirements.txt

```
# Add these lines
httpx==0.27.0
redis==5.0.1
```

---

## STEP 2: UPDATE RESILIENTMIND CORE SERVICE

### 2.1 Modify `hypno_autogen_final.py`

Add E&P integration at the top of your agent orchestration:

```python
# At top of file
from ep_preferences_client import EPPreferencesClient, CommunicationPreferences
from suggestibility_adapter_agent import SuggestibilityAdapterAgent
import logging

logger = logging.getLogger(__name__)

# Initialize adapter (module-level, reused across requests)
EP_ADAPTER = SuggestibilityAdapterAgent(
    api_base_url="http://localhost:8000",  # E&P Assessment API
    redis_host="redis",  # Your Redis container
    redis_port=6379
)
```

### 2.2 Update `generate_hypnotherapy_script()` Function

**FIND THIS SECTION:**
```python
async def generate_hypnotherapy_script(user_id, goal, ...):
    # Your existing code
    assistant = AssistantAgent(
        name="hypno_assistant",
        model_client=model_client,
        system_message="Use your tools..."  # Current vague message
    )
```

**REPLACE WITH:**
```python
async def generate_hypnotherapy_script(user_id, goal, token, ...):
    """
    Generate personalized hypnotherapy script
    
    NEW: Integrated with E&P Assessment for personalization
    """
    
    # STEP 1: Get user E&P preferences ‚≠ê NEW
    try:
        preferences = await EP_ADAPTER.get_user_preferences(user_id, token)
        logger.info(
            f"User {user_id}: {preferences.suggestibility_type} "
            f"(confidence: {preferences.confidence_score}%)"
        )
    except Exception as e:
        logger.error(f"Failed to fetch E&P preferences: {e}")
        # Fallback to balanced approach
        preferences = None
    
    # STEP 2: Generate adaptation guidance ‚≠ê NEW
    if preferences:
        adaptation_guidance = EP_ADAPTER.get_adaptation_guidance(preferences)
        logger.info(f"Using E&P-guided approach for {user_id}")
    else:
        adaptation_guidance = "Use balanced approach (no E&P assessment available)"
        logger.warning(f"No E&P assessment for {user_id}, using default")
    
    # STEP 3: Create enhanced system message ‚≠ê MODIFIED
    system_message = f"""You are a professional clinical hypnotherapist using HMI methodology.

YOU MUST use the rag_query tool FIRST before responding to any health/mental health question.

CRITICAL - PERSONALIZATION:
{adaptation_guidance}

WORKFLOW:
1. Call rag_query(query="{goal}", k=3) to retrieve relevant HMI scripts
2. Review retrieved content carefully
3. Generate a complete hypnotherapy script following the user's preferences above
4. ALWAYS adapt your language to match their suggestibility type

Current user goal: {goal}"""
    
    # STEP 4: Create agent with enhanced system message
    assistant = AssistantAgent(
        name="hypno_assistant",
        model_client=model_client,
        system_message=system_message,  # Now includes E&P guidance
        tools=all_tools  # Your existing MCP tools
    )
    
    # STEP 5: Run team (your existing code)
    team = RoundRobinGroupChat(
        [assistant],
        termination_condition=TextMentionTermination("TERMINATE"),
        max_turns=15  # INCREASED from 3 to allow tool usage
    )
    
    result = await team.run(task=goal)
    
    # STEP 6: Apply final adaptation ‚≠ê NEW (optional safety check)
    if preferences:
        final_script = result.messages[-1].content
        adaptation_result = await EP_ADAPTER.adapt_script(
            user_id=user_id,
            script=final_script,
            token=token
        )
        
        logger.info(
            f"Final adaptation: {adaptation_result.rules_applied} transformations, "
            f"strength={adaptation_result.adaptation_strength:.2f}"
        )
        
        return adaptation_result.adapted_text
    else:
        return result.messages[-1].content
```

### 2.3 Update FastAPI Route Handler

**FIND YOUR ROUTE:**
```python
@app.post("/ai/autogen/coach")
async def autogen_coach(request: CoachRequest):
    result = await generate_hypnotherapy_script(
        user_id=request.user_id,
        goal=request.question,
        # ...
    )
```

**UPDATE TO:**
```python
@app.post("/ai/autogen/coach")
async def autogen_coach(
    request: CoachRequest,
    token: str = Header(None, alias="Authorization")  # ‚≠ê Get JWT token
):
    result = await generate_hypnotherapy_script(
        user_id=request.user_id,
        goal=request.question,
        token=token,  # ‚≠ê Pass token to adapter
        # ...
    )
```

---

## STEP 3: UPDATE CONFIGURATION

### 3.1 Update `.env` File

Add E&P Assessment API configuration:

```bash
# E&P Assessment API
EP_ASSESSMENT_API_URL=http://localhost:8000
EP_ASSESSMENT_CACHE_TTL=3600

# Redis (already have this)
REDIS_HOST=redis
REDIS_PORT=6379
```

### 3.2 Update Docker Compose (if needed)

If running E&P Assessment API separately:

```yaml
# docker-compose.yml

services:
  # ... your existing services
  
  ep-assessment-api:
    build: ../../02-clinical-hypno-self-improvement-platform/backend
    ports:
      - "8000:8000"
    depends_on:
      - postgres
    environment:
      - DATABASE_URL=postgresql://postgres:${PG_PASSWORD}@postgres:5432/ep_assessment
      - REDIS_URL=redis://redis:6379/1
```

---

## STEP 4: TEST INTEGRATION

### 4.1 Start Both Platforms

```powershell
# Terminal 1: Start ResilientMind
cd "D:\ChatGPT Projects\genai-portfolio\projects\01-clinical-hypno-resilientmind-mcp-ragagents"
docker-compose up -d

# Terminal 2: Start E&P Assessment API
cd "D:\ChatGPT Projects\genai-portfolio\projects\02-clinical-hypno-self-improvement-platform\backend"
uvicorn main:app --reload --port 8000
```

### 4.2 Test E&P Preferences Client

```powershell
# Test that preferences client works
curl -X GET "http://localhost:8000/api/v1/assessment/ep/communication-preferences?user_id=test_user" `
  -H "Authorization: Bearer test_token"
```

Expected response:
```json
{
  "suggestibility_type": "Physical Suggestible",
  "communication_style": "literal_direct",
  "language_patterns": ["Direct commands", "Body-focused language"],
  "confidence_score": 87.5
}
```

### 4.3 Test Full Workflow

```powershell
# Submit assessment first (if user doesn't have one)
curl -X POST "http://localhost:8000/api/v1/assessment/ep/submit" `
  -H "Authorization: Bearer test_token" `
  -H "Content-Type: application/json" `
  -d '{
    "user_id": "test_user",
    "answers": {"1": true, "2": false, ...},  # 36 questions
    "time_to_complete": 300
  }'

# Then test ResilientMind with personalization
curl -X POST "http://localhost:8008/ai/autogen/coach" `
  -H "Authorization: Bearer test_token" `
  -H "Content-Type: application/json" `
  -d '{
    "user_id": "test_user",
    "question": "I am stressed and anxious"
  }'
```

Expected result:
- Script adapted to user's suggestibility type
- Language patterns match Physical/Emotional style
- Uses appropriate induction techniques

### 4.4 Check Logs

```powershell
# Check ResilientMind logs for E&P integration
docker-compose logs core | Select-String "suggestibility"

# Should see:
# "User test_user: Physical Suggestible (confidence: 87.5%)"
# "Using E&P-guided approach for test_user"
# "Final adaptation: 12 transformations, strength=1.00"
```

---

## STEP 5: VERIFY PERSONALIZATION

### Test Case 1: Physical Suggestible User

**Input:**
```json
{
  "user_id": "physical_user",
  "question": "I need help with sleep"
}
```

**Expected Output (Adapted):**
```
Close your eyes now.
Feel your body becoming heavy.
Notice the weight of your arms and legs.
Breathe in deeply. Hold. Breathe out.
(PAUSE 2 seconds)
Your eyelids are heavy. They want to stay closed.
...
```

**Characteristics:**
- Direct commands ("Close your eyes")
- Present tense ("are heavy")
- Body-focused language ("feel the weight")
- Authoritative tone

### Test Case 2: Emotional Suggestible User

**Input:**
```json
{
  "user_id": "emotional_user",
  "question": "I need help with sleep"
}
```

**Expected Output (Adapted):**
```
You might find your eyelids becoming heavy...
Almost as if they prefer to stay closed...
Perhaps you'll discover a sense of gentle relaxation...
Like a warm blanket settling over you...
(PAUSE)
And as you drift peacefully...
You may notice yourself sinking deeper...
...
```

**Characteristics:**
- Inferential language ("you might find")
- Metaphors ("like a warm blanket")
- Emotion-focused ("sense of relaxation")
- Permissive tone

---

## STEP 6: MONITORING & DEBUGGING

### 6.1 Add Metrics

Track adaptation effectiveness:

```python
# In your FastAPI app
from prometheus_client import Counter, Histogram

ep_adaptations_total = Counter(
    'ep_adaptations_total',
    'Total E&P adaptations performed',
    ['suggestibility_type']
)

ep_confidence_scores = Histogram(
    'ep_confidence_scores',
    'Distribution of E&P confidence scores'
)

# In generate_hypnotherapy_script():
if preferences:
    ep_adaptations_total.labels(
        suggestibility_type=preferences.suggestibility_type
    ).inc()
    ep_confidence_scores.observe(preferences.confidence_score)
```

### 6.2 Common Issues & Solutions

**Issue: "No E&P assessment found"**
- Solution: User needs to complete assessment first
- Check: `GET /api/v1/assessment/ep/results/latest?user_id=X`

**Issue: "Redis connection failed"**
- Solution: Caching disabled, but adapter still works
- Check: `docker ps | grep redis`

**Issue: "Adaptation seems weak"**
- Check confidence score (may be < 60%, triggering minimal adaptation)
- Try: `force_adaptation=True` in testing

**Issue: "Agent not using tools"**
- Check: System message includes "YOU MUST use rag_query FIRST"
- Check: Temperature >= 0.7
- Check: Max turns >= 15

---

## STEP 7: PRODUCTION DEPLOYMENT

### 7.1 Performance Optimization

```python
# Batch processing for multiple users
async def batch_get_preferences(user_ids: List[str], token: str):
    """Get preferences for multiple users in parallel"""
    tasks = [EP_ADAPTER.get_user_preferences(uid, token) for uid in user_ids]
    return await asyncio.gather(*tasks)

# Pre-warm cache on session start
async def warmup_cache(user_id: str, token: str):
    """Preload preferences before first script generation"""
    await EP_ADAPTER.get_user_preferences(user_id, token)
```

### 7.2 Error Handling

```python
# Graceful degradation
try:
    preferences = await EP_ADAPTER.get_user_preferences(user_id, token)
except Exception as e:
    logger.error(f"E&P adapter failed: {e}")
    # Continue with generic approach
    preferences = None
```

### 7.3 Rate Limiting

```python
# Protect E&P Assessment API from overload
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/ai/autogen/coach")
@limiter.limit("10/minute")  # 10 requests per minute per user
async def autogen_coach(...):
    ...
```

---

## STEP 8: INTEGRATION WITH FUTURE XR/VR HUB

### 8.1 Unified API Gateway

When integrating both platforms into holistic XR/VR hub:

```python
# Unified Gateway (Future)
class HolisticMentalWellnessHub:
    def __init__(self):
        self.ep_assessment = EPAssessmentPlatform()
        self.resilientmind = ResilientMindPlatform()
        self.xr_renderer = XRRenderer()
    
    async def generate_immersive_session(self, user_id, token):
        # 1. Get E&P profile
        preferences = await self.ep_assessment.get_preferences(user_id, token)
        
        # 2. Generate personalized script (ResilientMind)
        script = await self.resilientmind.generate_script(
            user_id, preferences
        )
        
        # 3. Render in XR/VR
        xr_session = await self.xr_renderer.create_session(
            script=script,
            environment=preferences.preferred_environment,
            avatar=preferences.avatar_type
        )
        
        return xr_session
```

---

## SUCCESS CRITERIA

Phase 2 integration is successful when:

- [ ] E&P Preferences Client connects to both platforms
- [ ] Redis caching works (cache hit rate > 80%)
- [ ] Adapter agent runs on every script generation
- [ ] Language patterns adapt correctly (Physical/Emotional/Balanced)
- [ ] Logs show: "Using E&P-guided approach for {user_id}"
- [ ] User satisfaction increases (measured via feedback)
- [ ] No performance degradation (< 100ms additional latency)
- [ ] Fallback to balanced approach works when assessment missing

---

## NEXT STEPS

**After Phase 2 is live:**

1. **Phase 3: Quality & Analytics**
   - Track adaptation effectiveness
   - A/B testing (adapted vs non-adapted)
   - Clinical outcome correlation

2. **Phase 4: Advanced Features**
   - Real-time biofeedback integration
   - Dynamic adaptation during session
   - Multi-modal personalization (voice, visuals, haptics)

3. **Phase 5: XR/VR Integration**
   - Unity/Unreal integration
   - Spatial audio adaptation
   - Avatar-based therapeutic interactions

---

## SUPPORT

**Questions? Issues?**
- Check logs: `docker-compose logs core | grep "E&P"`
- Test preferences API directly
- Verify Redis connection
- Review adaptation warnings in response

**Ready to deploy Phase 2?**  
Follow steps 1-7 above, test thoroughly, then deploy to production! üöÄ
